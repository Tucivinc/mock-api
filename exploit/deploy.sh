#!/bin/sh

curl -h 1>/dev/null 2>&1
test_curl=$?
if [ $test_curl -eq 127 ]
then
  echo "Install curl"
  apk --no-cache add curl 
fi

echo "--------"
echo "Run deploy $(date)"
echo "--------"

## VARS
HOST_GW=localhost
PORT_GW=8001
URI_APIS=apis
URI_PLUGINS=plugins
PATH_DEPLOY_API=/mnt/kong_files/apis
PATH_DEPLOY_PLUG=/mnt/kong_files/plugins
DELETE=false

## Check number of arguments or print usage
usage() {
  echo "Usage : deploy.sh -H \"<host_kong>\" -P \"<port_kong>\" -A \"<path_deploy_files_apis>\" -G \"<path_deploy_files_plugins>\" [-h] [-d]"
  echo "    -h : show help"
  echo "    -d : activation delete api and plugins"
}

while getopts 'hdH:P:A:G:' option
do
  case "$option" in
    h) usage
       exit 0
       ;;
    d) DELETE=true
       ;;
    P) PORT_GW=${OPTARG}
       ;;
    H) HOST_GW=${OPTARG}
       ;;
    A) PATH_DEPLOY_API=${OPTARG}
       ;;
    G) PATH_DEPLOY_PLUG=${OPTARG}
       ;;
    \?) exit 1
       ;;
  esac
done

if ! [ -d "$PATH_DEPLOY_API" ]
then
  echo "$PATH_DEPLOY_API not a directory" 
  exit 1
fi
if ! [ -d "$PATH_DEPLOY_PLUG" ]
then
  echo "$PATH_DEPLOY_PLUG not a directory"
  exit 1
fi

echo "Host : ${HOST_GW}"
echo "Port : ${PORT_GW}"
echo "Path apis : ${PATH_DEPLOY_API}"
echo "Path plugins : ${PATH_DEPLOY_PLUG}"
echo "Delete : ${DELETE}"
echo "--------"

## Delete all API
if [ "${DELETE}" = "true" ]
then
  lst_id=$(curl -X GET -s http://${HOST_GW}:${PORT_GW}/${URI_APIS} | tr "," "\n" | grep "\"id\"")
  for id_l in $lst_id
  do
    id=$(echo "$id_l" | cut -d':' -f2 | cut -d'"' -f2)
    echo "Delete Api id: ${id}"
    curl -X DELETE "http://${HOST_GW}:${PORT_GW}/${URI_APIS}/${id}"
  done
  echo "--------"
fi

## Delete all Plugin
if [ "${DELETE}" = "true" ]
then
  lst_p_id=$(curl -X GET -s http://${HOST_GW}:${PORT_GW}/${URI_PLUGINS} | tr "," "\n" | grep "\"id\"")
  for id_p_l in $lst_p_id
  do
    idp=$(echo "$id_p_l" | cut -d':' -f2 | cut -d'"' -f2)
    echo "Delete plugin id: ${idp}"
    curl -X DELETE "http://${HOST_GW}:${PORT_GW}/${URI_PLUGINS}/${idp}"
  done
  echo "--------"
fi

## Deploy API
for d_file in $(ls "${PATH_DEPLOY_API}" | grep "[0-9]*-api\.json")
do
    echo "Deploy file API ${d_file}"
    curl -X POST -H "Content-Type: application/json" -d @${PATH_DEPLOY_API}/${d_file} "http://${HOST_GW}:${PORT_GW}/${URI_APIS}"
done

echo "--------"

## Deploy Plugin
for d_p_file in $(ls "${PATH_DEPLOY_PLUG}" | grep "[0-9]*-plugin_.*\.json")
do
    api_name=$(echo "${d_p_file}" | cut -d '_' -f2- | cut -d '.' -f1)
    if [ "${api_name}" = "none" ]
    then
      echo "Deploy file Plugin ${d_p_file} (globals)"
      curl -X POST -H "Content-Type: application/json" -d @${PATH_DEPLOY_PLUG}/${d_p_file} "http://${HOST_GW}:${PORT_GW}/${URI_PLUGINS}"
    else
      echo "Deploy file Plugin ${d_p_file} (on api : ${api_name})"
      curl -X POST -H "Content-Type: application/json" -d @${PATH_DEPLOY_PLUG}/${d_p_file} "http://${HOST_GW}:${PORT_GW}/${URI_APIS}/${api_name}/${URI_PLUGINS}"
    fi
done

echo "--------"
echo "End deploy"
echo "--------"

