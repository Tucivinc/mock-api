#!/bin/sh

checkStatusCode(){
  STATUS=$1
  URL=$2
  RETOUR=$(curl -s -w "\n->#CODERETOUR=%{http_code}\n" --show-error -X GET --header 'Accept: application/json' "${URL}")
  CODE_RETOUR=$(echo "${RETOUR}" | grep "#CODERETOUR=" | sed 's/^.*#CODERETOUR=\([0-9]*\)$/\1/')
  if [ "${CODE_RETOUR}" = "${STATUS}" ]
  then
    return 0
  else
    return 1
  fi
}

if [ -z ${CHECK_URL_SERVICE_UP} ]
then
  CHECK_URL_SERVICE_UP="https://www.docker.com/"
  echo "Warning : CHECK_URL_SERVICE_UP not set"
fi
if [ -z ${CHECK_STATUS_SERVICE_UP} ]
then
  CHECK_STATUS_SERVICE_UP=200
  echo "Warning : CHECK_STATUS_SERVICE_UP not set"
fi
if [ -z ${CHECK_RETRY_SERVICE_UP} ]
then
  CHECK_TIMEOUT_SERVICE_UP=60
  echo "Warning : CHECK_TIMEOUT_SERVICE_UP not set"
fi

URL=${CHECK_URL_SERVICE_UP}
STATUS_CHECK=${CHECK_STATUS_SERVICE_UP}
RETRY=${CHECK_RETRY_SERVICE_UP}
cmd=$@
cpt=0
until $(checkStatusCode ${STATUS_CHECK} ${URL})
do
  >&2 echo "Service is unavailable - sleeping"
  cpt=$((cpt+1))
  if [ "${cpt}" -gt ${RETRY} ]
  then
    echo "Service is down (${RETRY} calls fails)"
    exit 1
  fi
  sleep 2
done

echo "Run command : ${cmd}"
${cmd}
